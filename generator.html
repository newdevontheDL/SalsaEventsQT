<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Salsa Events JSON Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1rem;
      background: #0b1020;
      color: #f5f5f5;
    }
    h1 {
      margin-top: 0;
    }
    .wrapper {
      max-width: 1100px;
      margin: 0 auto;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .card {
      border-radius: 12px;
      padding: 0.8rem 1rem;
      background: #15192a;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .card h2 {
      font-size: 1rem;
      margin: 0 0 0.5rem;
    }
    label {
      display: block;
      font-size: 0.8rem;
      margin-top: 0.4rem;
    }
    input, select {
      width: 100%;
      box-sizing: border-box;
      padding: 0.25rem 0.4rem;
      margin-top: 0.1rem;
      border-radius: 4px;
      border: 1px solid #3a3f5c;
      background: #0b1020;
      color: #f5f5f5;
      font-size: 0.85rem;
    }
    input[type="checkbox"] {
      width: auto;
      margin-right: 0.3rem;
    }
    .row-inline {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    button {
      padding: 0.5rem 1rem;
      border-radius: 999px;
      border: 1px solid #ff4b6e;
      background: #ff4b6e;
      color: #0b1020;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 0.8rem;
    }
    button:hover {
      filter: brightness(1.05);
    }
    textarea {
      width: 100%;
      box-sizing: border-box;
      min-height: 260px;
      padding: 0.6rem;
      border-radius: 8px;
      border: 1px solid #3a3f5c;
      background: #050815;
      color: #f5f5f5;
      font-family: "SF Mono", Menlo, Consolas, monospace;
      font-size: 0.8rem;
      resize: vertical;
    }
    .hint {
      font-size: 0.8rem;
      opacity: 0.8;
      margin-bottom: 0.5rem;
    }
    .error {
      color: #ffb3c3;
      font-size: 0.8rem;
      margin-bottom: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <h1>Salsa Events JSON Generator</h1>
    <p class="hint">
      Fill in up to 4 weekly classes. Uses <code>meta.json</code> for cities, styles, types and venues.
      Click <strong>Generate JSON</strong>, then paste the output into <code>events.json</code>.
      Times are saved as NZ local with the correct offset (<code>+12:00</code> / <code>+13:00</code>).
    </p>

    <div class="grid">
      <!-- Class 1 -->
      <div class="card">
        <h2>Class 1</h2>
        <div class="row-inline">
          <input type="checkbox" id="c1_enabled" checked>
          <label for="c1_enabled">Enabled</label>
        </div>
        <label>
          Title
          <input id="c1_title" value="Cuban Salsa - Beginners">
        </label>

        <label>
          City
          <select id="c1_city" class="city-select"></select>
        </label>

        <label>
          Style
          <select id="c1_style" class="style-select"></select>
        </label>

        <label>
          Type
          <select id="c1_type" class="type-select"></select>
        </label>

        <label>
          Venue
          <select id="c1_venue" class="venue-select"></select>
        </label>

        <label>
          Weekday
          <select id="c1_weekday">
            <option value="1">Monday</option>
            <option value="2" selected>Tuesday</option>
            <option value="3">Wednesday</option>
            <option value="4">Thursday</option>
            <option value="5">Friday</option>
            <option value="6">Saturday</option>
            <option value="0">Sunday</option>
          </select>
        </label>
        <label>
          Start time
          <input type="time" id="c1_time_start" value="18:30" step="60">
        </label>
        <label>
          End time
          <input type="time" id="c1_time_end" value="19:30" step="60">
        </label>
        <label>
          Start date
          <input type="date" id="c1_start" value="2026-01-06">
        </label>
        <label>
          End date
          <input type="date" id="c1_end" value="2026-03-31">
        </label>
        <label>
          Link (optional)
          <input id="c1_link" value="https://example.com/cuban-beginners">
        </label>
        <label>
          imageUrl
          <input id="c1_image" value="img/cuban-beginners.png">
        </label>
      </div>

      <!-- Class 2 -->
      <div class="card">
        <h2>Class 2</h2>
        <div class="row-inline">
          <input type="checkbox" id="c2_enabled" checked>
          <label for="c2_enabled">Enabled</label>
        </div>
        <label>
          Title
          <input id="c2_title" value="Cuban Salsa - Improvers">
        </label>

        <label>
          City
          <select id="c2_city" class="city-select"></select>
        </label>

        <label>
          Style
          <select id="c2_style" class="style-select"></select>
        </label>

        <label>
          Type
          <select id="c2_type" class="type-select"></select>
        </label>

        <label>
          Venue
          <select id="c2_venue" class="venue-select"></select>
        </label>

        <label>
          Weekday
          <select id="c2_weekday">
            <option value="1">Monday</option>
            <option value="2" selected>Tuesday</option>
            <option value="3">Wednesday</option>
            <option value="4">Thursday</option>
            <option value="5">Friday</option>
            <option value="6">Saturday</option>
            <option value="0">Sunday</option>
          </select>
        </label>
        <label>
          Start time
          <input type="time" id="c2_time_start" value="19:45" step="60">
        </label>
        <label>
          End time
          <input type="time" id="c2_time_end" value="20:45" step="60">
        </label>
        <label>
          Start date
          <input type="date" id="c2_start" value="2026-01-06">
        </label>
        <label>
          End date
          <input type="date" id="c2_end" value="2026-03-31">
        </label>
        <label>
          Link (optional)
          <input id="c2_link" value="https://example.com/cuban-improvers">
        </label>
        <label>
          imageUrl
          <input id="c2_image" value="img/cuban-improvers.png">
        </label>
      </div>

      <!-- Class 3 -->
      <div class="card">
        <h2>Class 3</h2>
        <div class="row-inline">
          <input type="checkbox" id="c3_enabled" checked>
          <label for="c3_enabled">Enabled</label>
        </div>
        <label>
          Title
          <input id="c3_title" value="Bachata - Beginners">
        </label>

        <label>
          City
          <select id="c3_city" class="city-select"></select>
        </label>

        <label>
          Style
          <select id="c3_style" class="style-select"></select>
        </label>

        <label>
          Type
          <select id="c3_type" class="type-select"></select>
        </label>

        <label>
          Venue
          <select id="c3_venue" class="venue-select"></select>
        </label>

        <label>
          Weekday
          <select id="c3_weekday">
            <option value="1">Monday</option>
            <option value="2">Tuesday</option>
            <option value="3">Wednesday</option>
            <option value="4" selected>Thursday</option>
            <option value="5">Friday</option>
            <option value="6">Saturday</option>
            <option value="0">Sunday</option>
          </select>
        </label>
        <label>
          Start time
          <input type="time" id="c3_time_start" value="18:30" step="60">
        </label>
        <label>
          End time
          <input type="time" id="c3_time_end" value="19:30" step="60">
        </label>
        <label>
          Start date
          <input type="date" id="c3_start" value="2026-01-08">
        </label>
        <label>
          End date
          <input type="date" id="c3_end" value="2026-04-02">
        </label>
        <label>
          Link (optional)
          <input id="c3_link" value="https://example.com/bachata-beginners">
        </label>
        <label>
          imageUrl
          <input id="c3_image" value="img/bachata-beginners.png">
        </label>
      </div>

      <!-- Class 4 -->
      <div class="card">
        <h2>Class 4</h2>
        <div class="row-inline">
          <input type="checkbox" id="c4_enabled" checked>
          <label for="c4_enabled">Enabled</label>
        </div>
        <label>
          Title
          <input id="c4_title" value="Bachata - Open Level">
        </label>

        <label>
          City
          <select id="c4_city" class="city-select"></select>
        </label>

        <label>
          Style
          <select id="c4_style" class="style-select"></select>
        </label>

        <label>
          Type
          <select id="c4_type" class="type-select"></select>
        </label>

        <label>
          Venue
          <select id="c4_venue" class="venue-select"></select>
        </label>

        <label>
          Weekday
          <select id="c4_weekday">
            <option value="1">Monday</option>
            <option value="2">Tuesday</option>
            <option value="3">Wednesday</option>
            <option value="4" selected>Thursday</option>
            <option value="5">Friday</option>
            <option value="6">Saturday</option>
            <option value="0">Sunday</option>
          </select>
        </label>
        <label>
          Start time
          <input type="time" id="c4_time_start" value="19:45" step="60">
        </label>
        <label>
          End time
          <input type="time" id="c4_time_end" value="20:45" step="60">
        </label>
        <label>
          Start date
          <input type="date" id="c4_start" value="2026-01-08">
        </label>
        <label>
          End date
          <input type="date" id="c4_end" value="2026-04-02">
        </label>
        <label>
          Link (optional)
          <input id="c4_link" value="https://example.com/bachata-open">
        </label>
        <label>
          imageUrl
          <input id="c4_image" value="img/social.png">
        </label>
      </div>
    </div>

    <div class="card">
      <h2>One-off Events (optional)</h2>
      <p class="hint">
        Enter extra events as valid JSON array items (no surrounding <code>[ ]</code>).<br>
        They should use IDs for <code>city</code>, <code>style</code>, <code>type</code>, <code>venue</code>, e.g.:<br>
        <code>{ "title": "Ritmo Queenstown", "dateTime": "2026-02-13T18:30:00+13:00", "endDateTime": "2026-02-13T21:00:00+13:00", "city": "queenstown", "style": "salsa", "type": "special", "venue": "te-atamira", ... }</code>
      </p>
      <textarea id="oneOffInput" placeholder='Example:
{ "title": "Ritmo Queenstown", "dateTime": "2026-02-13T18:30:00+13:00", "endDateTime": "2026-02-13T21:00:00+13:00", "city": "queenstown", "style": "salsa", "type": "special", "venue": "te-atamira", "link": "https://events.humanitix.com/ritmo-queenstown", "imageUrl": "https://..." }'></textarea>
    </div>

    <div class="error" id="errorBox" style="display:none;"></div>

    <button id="generateBtn">Generate JSON</button>
    <p class="hint">
      Copy this into <code>events.json</code> in your repo.
    </p>
    <textarea id="output" readonly></textarea>
  </div>

  <script>
    let metaData = null;

    // --- NZ local datetime -> ISO string with correct offset (+12 / +13) ---
    function toLocalIsoWithOffset(dateObj) {
      const pad = n => String(n).padStart(2, "0");

      const year   = dateObj.getFullYear();
      const month  = pad(dateObj.getMonth() + 1);
      const day    = pad(dateObj.getDate());
      const hour   = pad(dateObj.getHours());
      const minute = pad(dateObj.getMinutes());
      const second = pad(dateObj.getSeconds());

      // JS: getTimezoneOffset is minutes behind UTC (negative for positive TZ)
      const offsetMinutes = -dateObj.getTimezoneOffset();
      const sign = offsetMinutes >= 0 ? "+" : "-";
      const abs  = Math.abs(offsetMinutes);
      const offH = pad(Math.floor(abs / 60));
      const offM = pad(abs % 60);

      return `${year}-${month}-${day}T${hour}:${minute}:${second}${sign}${offH}:${offM}`;
    }

    // --- Load meta.json, populate city / style / type / venue selects ---
    async function loadMeta() {
      try {
        const res = await fetch("meta.json?cache=" + Date.now());
        if (!res.ok) throw new Error("HTTP " + res.status);
        metaData = await res.json();

        populateCitySelects(metaData.cities || []);
        populateStyleSelects(metaData.styles || []);
        populateTypeSelects(metaData.types || []);
        populateVenueSelects(metaData.venues || []);

        // Set some sensible defaults if these IDs exist
        setDefaultValue("c1_city", "queenstown");
        setDefaultValue("c2_city", "queenstown");
        setDefaultValue("c3_city", "queenstown");
        setDefaultValue("c4_city", "queenstown");

        setDefaultValue("c1_style", "salsa");
        setDefaultValue("c2_style", "salsa");
        setDefaultValue("c3_style", "bachata");
        setDefaultValue("c4_style", "bachata");

        setDefaultValue("c1_type", "class");
        setDefaultValue("c2_type", "class");
        setDefaultValue("c3_type", "class");
        setDefaultValue("c4_type", "class");

        setDefaultValue("c1_venue", "te-atamira");
        setDefaultValue("c2_venue", "te-atamira");
        setDefaultValue("c3_venue", "te-atamira");
        setDefaultValue("c4_venue", "te-atamira");
      } catch (err) {
        console.error("Failed to load meta.json:", err);
      }
    }

    function setDefaultValue(id, value) {
      const el = document.getElementById(id);
      if (!el) return;
      if ([...el.options].some(o => o.value === value)) {
        el.value = value;
      }
    }

    function populateCitySelects(cities) {
      const selects = document.querySelectorAll(".city-select");
      selects.forEach(sel => {
        sel.innerHTML = "";
        cities.forEach(city => {
          const opt = document.createElement("option");
          opt.value = city.id;
          opt.textContent = city.name;
          sel.appendChild(opt);
        });
      });
    }

    function populateStyleSelects(styles) {
      const selects = document.querySelectorAll(".style-select");
      selects.forEach(sel => {
        sel.innerHTML = "";
        styles.forEach(style => {
          const opt = document.createElement("option");
          opt.value = style.id;
          opt.textContent = style.name;
          sel.appendChild(opt);
        });
      });
    }

    function populateTypeSelects(types) {
      const selects = document.querySelectorAll(".type-select");
      selects.forEach(sel => {
        sel.innerHTML = "";
        types.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t.id;
          opt.textContent = t.label;
          sel.appendChild(opt);
        });
      });
    }

    function populateVenueSelects(venues) {
      const selects = document.querySelectorAll(".venue-select");
      selects.forEach(sel => {
        sel.innerHTML = "";
        venues.forEach(v => {
          const opt = document.createElement("option");
          opt.value = v.id;
          opt.textContent = v.name;
          sel.appendChild(opt);
        });
      });
    }

    function parseDateParts(isoDate) {
      const parts = isoDate.split("-");
      if (parts.length !== 3) return null;
      const year = Number(parts[0]);
      const month = Number(parts[1]);
      const day = Number(parts[2]);
      if (!year || !month || !day) return null;
      return { year, month, day };
    }

    function parseTimeParts(timeStr, label) {
      const parts = timeStr.split(":");
      if (parts.length < 2) {
        throw new Error("Invalid " + label + " time: " + timeStr);
      }
      const hour = Number(parts[0]);
      const minute = Number(parts[1]);
      if (Number.isNaN(hour) || Number.isNaN(minute)) {
        throw new Error("Invalid " + label + " time: " + timeStr);
      }
      return { hour, minute };
    }

    function generateWeeklyFromPattern(pattern) {
      const {
        title,
        city,
        style,
        type,
        venue,
        weekday,
        startTime,
        endTime,
        startDate,
        endDate,
        link,
        imageUrl
      } = pattern;

      const startParts = parseDateParts(startDate);
      const endParts = parseDateParts(endDate);
      if (!startParts || !endParts) {
        throw new Error("Invalid date in pattern: " + title);
      }

      const startTimeParts = parseTimeParts(startTime, "start");
      const endTimeParts = parseTimeParts(endTime, "end");

      const start = new Date(startParts.year, startParts.month - 1, startParts.day);
      const end = new Date(endParts.year, endParts.month - 1, endParts.day);

      // Move start to the first desired weekday on/after startDate
      while (start.getDay() !== weekday) {
        start.setDate(start.getDate() + 1);
      }

      const events = [];
      const current = new Date(start.getTime());

      while (current <= end) {
        const startDateObj = new Date(current.getTime());
        startDateObj.setHours(startTimeParts.hour, startTimeParts.minute, 0, 0);

        const endDateObj = new Date(current.getTime());
        endDateObj.setHours(endTimeParts.hour, endTimeParts.minute, 0, 0);

        const isoStart = toLocalIsoWithOffset(startDateObj);
        const isoEnd   = toLocalIsoWithOffset(endDateObj);

        events.push({
          title,
          city,
          style,
          type,
          venue,
          dateTime: isoStart,
          endDateTime: isoEnd,
          link,
          imageUrl
        });

        current.setDate(current.getDate() + 7); // next week
      }

      return events;
    }

    function collectPattern(prefix) {
      const enabled = document.getElementById(prefix + "_enabled").checked;
      if (!enabled) return null;

      const title = document.getElementById(prefix + "_title").value.trim();
      const city = document.getElementById(prefix + "_city").value.trim();
      const style = document.getElementById(prefix + "_style").value.trim();
      const type = document.getElementById(prefix + "_type").value.trim();
      const venue = document.getElementById(prefix + "_venue").value.trim();
      const weekday = Number(document.getElementById(prefix + "_weekday").value);
      const startTime = document.getElementById(prefix + "_time_start").value.trim();
      const endTime = document.getElementById(prefix + "_time_end").value.trim();
      const startDate = document.getElementById(prefix + "_start").value.trim();
      const endDate = document.getElementById(prefix + "_end").value.trim();
      const link = document.getElementById(prefix + "_link").value.trim();
      const imageUrl = document.getElementById(prefix + "_image").value.trim();

      if (!title || !startDate || !endDate || !startTime || !endTime) {
        return null; // skip incomplete
      }

      return {
        title,
        city,
        style,
        type,
        venue,
        weekday,
        startTime,
        endTime,
        startDate,
        endDate,
        link,
        imageUrl
      };
    }

    function parseOneOffEvents(raw) {
      const trimmed = raw.trim();
      if (!trimmed) return [];
      try {
        const json = JSON.parse("[" + trimmed + "]");
        if (!Array.isArray(json)) return [];
        return json;
      } catch (e) {
        throw new Error("One-off events JSON is invalid: " + e.message);
      }
    }

    document.getElementById("generateBtn").addEventListener("click", () => {
      const errorBox = document.getElementById("errorBox");
      const output = document.getElementById("output");
      errorBox.style.display = "none";
      errorBox.textContent = "";
      output.value = "";

      try {
        const patterns = [];
        ["c1", "c2", "c3", "c4"].forEach(prefix => {
          const pat = collectPattern(prefix);
          if (pat) patterns.push(pat);
        });

        let events = [];

        patterns.forEach(p => {
          const evts = generateWeeklyFromPattern(p);
          events = events.concat(evts);
        });

        const oneOffRaw = document.getElementById("oneOffInput").value;
        const oneOff = parseOneOffEvents(oneOffRaw);
        events = events.concat(oneOff);

        events.sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));

        output.value = JSON.stringify(events, null, 2);
      } catch (err) {
        errorBox.textContent = err.message;
        errorBox.style.display = "block";
      }
    });

    // Init
    loadMeta();
  </script>
</body>
</html>
